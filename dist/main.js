(()=>{"use strict";const e="@group(0) @binding(0) var screen_sampler : sampler;\r\n@group(0) @binding(1) var color_buffer : texture_2d<f32>;\r\n\r\nstruct VertexOutput {\r\n        @builtin(position) Position : vec4<f32>,\r\n            @location(0) TexCoord : vec2<f32>,\r\n}\r\n\r\n@vertex\r\nfn vert_main(@builtin(vertex_index) VertexIndex : u32) -> VertexOutput {\r\n    var positions = array<vec2<f32>, 6>(\r\n        vec2<f32>( 1.0,  1.0),\r\n        vec2<f32>( 1.0, -1.0),\r\n        vec2<f32>(-1.0, -1.0),\r\n        vec2<f32>( 1.0,  1.0),\r\n        vec2<f32>(-1.0, -1.0),\r\n        vec2<f32>(-1.0,  1.0)\r\n    );\r\n\r\n    var texCoords = array<vec2<f32>, 6>(\r\n        vec2<f32>(1.0, 0.0),\r\n        vec2<f32>(1.0, 1.0),\r\n        vec2<f32>(0.0, 1.0),\r\n        vec2<f32>(1.0, 0.0),\r\n        vec2<f32>(0.0, 1.0),\r\n        vec2<f32>(0.0, 0.0)\r\n    );\r\n\r\n    var output : VertexOutput;\r\n    output.Position = vec4<f32>(positions[VertexIndex], 0.0, 1.0);\r\n    output.TexCoord = texCoords[VertexIndex];\r\n    return output;\r\n}\r\n\r\n@fragment\r\nfn frag_main(@location(0) TexCoord : vec2<f32>) -> @location(0) vec4<f32> {\r\n    return textureSample(color_buffer, screen_sampler, TexCoord);\r\n}";var i=function(e,i,r,t){return new(r||(r=Promise))((function(n,o){function a(e){try{c(t.next(e))}catch(e){o(e)}}function s(e){try{c(t.throw(e))}catch(e){o(e)}}function c(e){var i;e.done?n(e.value):(i=e.value,i instanceof r?i:new r((function(e){e(i)}))).then(a,s)}c((t=t.apply(e,i||[])).next())}))};const r=document.getElementById("canv"),t=document.getElementById("fps"),n=new class{constructor(e){this.render=()=>{var e,i,r;const t=null===(e=this.device)||void 0===e?void 0:e.createCommandEncoder(),n=null==t?void 0:t.beginComputePass();null==n||n.setPipeline(this.ray_tracing_pipeline),null==n||n.setBindGroup(0,this.ray_tracing_bind_group),null==n||n.dispatchWorkgroups(this.canvas.width,this.canvas.height,1),null==n||n.end();const o=null===(i=this.context)||void 0===i?void 0:i.getCurrentTexture().createView(),a=null==t?void 0:t.beginRenderPass({colorAttachments:[{view:o,clearValue:{r:.5,g:0,b:.25,a:1},loadOp:"clear",storeOp:"store"}]});null==a||a.setPipeline(this.screen_pipeline),null==a||a.setBindGroup(0,this.screen_bind_group),null==a||a.draw(6,1,0,0),null==a||a.end(),null===(r=this.device)||void 0===r||r.queue.submit([null==t?void 0:t.finish()])},this.canvas=e}Initialize(){return i(this,void 0,void 0,(function*(){yield this.setupDevice(),yield this.createAssets(),yield this.setupPipeline()}))}setupDevice(){var e,r;return i(this,void 0,void 0,(function*(){this.adapter=yield null===(e=navigator.gpu)||void 0===e?void 0:e.requestAdapter(),this.device=yield null===(r=this.adapter)||void 0===r?void 0:r.requestDevice(),this.context=this.canvas.getContext("webgpu"),this.format="bgra8unorm",this.context.configure({device:this.device,format:this.format,alphaMode:"opaque"})}))}createAssets(){var e,r,t;return i(this,void 0,void 0,(function*(){this.color_buffer=null===(e=this.device)||void 0===e?void 0:e.createTexture({size:{width:this.canvas.width,height:this.canvas.height},format:"rgba8unorm",usage:GPUTextureUsage.COPY_DST|GPUTextureUsage.STORAGE_BINDING|GPUTextureUsage.TEXTURE_BINDING}),this.color_buffer_view=null===(r=this.color_buffer)||void 0===r?void 0:r.createView(),this.sampler=null===(t=this.device)||void 0===t?void 0:t.createSampler({addressModeU:"repeat",addressModeV:"repeat",magFilter:"linear",minFilter:"nearest",mipmapFilter:"nearest",maxAnisotropy:1})}))}setupPipeline(){var r,t,n,o,a,s,c,u;return i(this,void 0,void 0,(function*(){const i=null===(r=this.device)||void 0===r?void 0:r.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,storageTexture:{access:"write-only",format:"rgba8unorm",viewDimension:"2d"}}]});this.ray_tracing_bind_group=null===(t=this.device)||void 0===t?void 0:t.createBindGroup({layout:i,label:"Ray tracing bind group",entries:[{binding:0,resource:this.color_buffer_view}]});const l=null===(n=this.device)||void 0===n?void 0:n.createPipelineLayout({bindGroupLayouts:[i]});this.ray_tracing_pipeline=null===(o=this.device)||void 0===o?void 0:o.createComputePipeline({label:"Ray tracing pipeline",layout:l,compute:{entryPoint:"main",module:this.device.createShaderModule({code:"@group(0) @binding(0) var color_buffer: texture_storage_2d<rgba8unorm, write>;\r\n\r\n@compute @workgroup_size(1,1,1)\r\nfn main(@builtin(global_invocation_id) GlobalInvocationID : vec3<u32>) {\r\n    let screen_size: vec2<u32> = textureDimensions(color_buffer);\r\n    let screen_pos : vec2<i32> = vec2<i32>(i32(GlobalInvocationID.x), i32(GlobalInvocationID.y));\r\n\r\n    var pixel_color : vec3<f32> = vec3<f32>(f32(screen_pos[0]) / f32(screen_size[0]), 0.0, 0.25);\r\n\r\n    textureStore(color_buffer, screen_pos, vec4<f32>(pixel_color, 1.0));\r\n}"})}});const d=null===(a=this.device)||void 0===a?void 0:a.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:1,visibility:GPUShaderStage.FRAGMENT,texture:{}}]});this.screen_bind_group=null===(s=this.device)||void 0===s?void 0:s.createBindGroup({layout:d,entries:[{binding:0,resource:this.sampler},{binding:1,resource:this.color_buffer_view}]});const v=null===(c=this.device)||void 0===c?void 0:c.createPipelineLayout({bindGroupLayouts:[d]});this.screen_pipeline=null===(u=this.device)||void 0===u?void 0:u.createRenderPipeline({layout:v,vertex:{module:this.device.createShaderModule({code:e}),entryPoint:"vert_main"},fragment:{module:this.device.createShaderModule({code:e}),entryPoint:"frag_main",targets:[{format:"bgra8unorm"}]},primitive:{topology:"triangle-list",cullMode:"back",frontFace:"cw"}})}))}}(r);n.Initialize();let o=performance.now();requestAnimationFrame((function e(){n.render();const i=performance.now()-o;o=performance.now(),t.innerText=Math.round(1/i*1e3).toString()+" fps",requestAnimationFrame(e)}))})();